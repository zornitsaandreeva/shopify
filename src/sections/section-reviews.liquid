<!-- /sections/section-reviews.liquid -->

{%- liquid
  assign show_featured_image = section.settings.show_featured_image
  assign aspect_ratio = 1 | divided_by: section.settings.image_aspect_ratio
  assign show_quotation_marks = section.settings.show_quotation_marks
  assign bg_color = section.settings.bg_color
  assign text_color = section.settings.color
  assign text_size = section.settings.text_size
  assign card_bg_color = section.settings.card_bg_color

  case section.blocks.size
    when 1
      assign grid_item_width = 'large-up--one-whole medium--one-half small--seven-eighths'
    when 2
      assign grid_item_width = 'large-up--one-half medium--one-half small--seven-eighths'
    when 3
      if show_featured_image
        assign grid_item_width = 'large-up--one-half medium--one-half small--seven-eighths'
      else
        assign grid_item_width = 'large-up--one-third medium--one-half small--seven-eighths'
      endif
    else
      if show_featured_image
        assign grid_item_width = 'large-up--one-half medium--one-half small--seven-eighths'
      else
        assign grid_item_width = 'large-up--one-quarter medium--one-half small--seven-eighths'
      endif
  endcase

  assign animation_anchor = "[data-section-id='" | append: section.id | append: "']"

  assign section_classes = 'reviews reviews--section' | append: ' ' | append: section.settings.text_align
  if show_featured_image
    assign section_classes = section_classes | append: ' ' | append: 'reviews--have-images'
  endif

  capture sizes
    if settings.block.size == 1
      echo '(min-width: 768px) 50vw, calc(100vw - 82px)'
    else
      echo '(min-width: 768px) 25vw, calc(100vw - 82px)'
    endif
  endcapture

  assign widths = '240, 256, 296, 320, 360, 480, 512, 592, 640, 720, 960, 1024, 1080, 1184, 1280'
-%}

{%- style -%}
  #Reviews--{{ section.id }} {
    --PT: {{ section.settings.padding_top }}px;
    --PB: {{ section.settings.padding_bottom }}px;
    {% unless text_color == 'rgba(0,0,0,0)' or text_color == blank %}
      --text: {{ text_color }};
    {% endunless %}
    {% unless bg_color == 'rgba(0,0,0,0)' or bg_color == blank %}
      --bg: {{ bg_color }};
    {% endunless %}
    {% unless card_bg_color == 'rgba(0,0,0,0)' or card_bg_color == blank %}
      --card-bg: {{ card_bg_color }};
    {% endunless %}
  }
{%- endstyle -%}

{%- capture slider_attributes -%}
  data-slider="{{ section.id }}"
  data-options='{"watchCSS": true, "pageDots": false, "prevNextButtons": true, "adaptiveHeight": false, "wrapAround": false, "groupCells": true, "cellAlign": "left"}'
  data-equalize-height="true"
  data-block-scroll
{%- endcapture -%}

<div id="Reviews--{{ section.id }}"
  class="{{ section_classes }}"
  data-section-id="{{ section.id }}"
  data-section-type="reviews">
  {%- if section.blocks.size > 0 -%}
    <div class="reviews__grid grid section-padding" {{ slider_attributes }}>
      {%- for block in section.blocks -%}
        {%- liquid
          assign block_title = block.settings.title
          assign review = block.settings.review_text
          assign featured_image = block.settings.featured_image
          assign bio_image = block.settings.bio_image
          assign subheading = block.settings.subheading
          assign review_url = block.settings.review_url
          assign layout_slide_attributes = 'data-slide="' | append: block.id | append: '" data-slide-index="' | append: forloop.index0 | append: '"'
          assign animation_delay = forloop.index0 | times: 150

          assign review_block_classes = 'review'
          if show_featured_image
            assign review_block_classes = review_block_classes | append: ' review--has-image'
          endif
        -%}

        <div class="reviews__grid-item {{ grid_item_width }}" {{ layout_slide_attributes }} {{ block.shopify_attributes }}>
          {%- if review_url != blank -%}
            <a href="{{ review_url }}" class="{{ review_block_classes }}" rel="noopener" target="_blank">
          {%- else -%}
            <div class="{{ review_block_classes }}">
          {%- endif -%}

            {%- if show_featured_image -%}
              <div class="review__image">
                {%- capture attributes -%}
                  data-aos="img-in"
                  data-aos-anchor="{{ animation_anchor }}"
                  data-aos-delay="{{ animation_delay }}"
                  data-aos-duration="800"
                  data-aos-easing="ease-out-quart"
                {%- endcapture -%}

                {%- if featured_image -%}
                  {%- render 'image' image: featured_image, sizes: sizes, attributes: attributes, aspect_ratio: aspect_ratio -%}
                {%- else -%}
                  <div class="image-wrapper" style="--aspect-ratio: {{ aspect_ratio }};" {{ attributes }}>
                    {{ 'image' | placeholder_svg_tag: 'svg-placeholder' }}
                  </div>
                {%- endif -%}
              </div>
            {%- endif -%}

            <div class="review__content">
              {%- if review != blank -%}
                {%- liquid
                  assign font_size_class = text_size | prepend: 'body-size-'
                  assign quotes_shift_multiplier = text_size | at_least: 2

                  capture quotes_styles
                    echo 'font-size: calc(var(--font-' | append: text_size | append: ') * (var(--FONT-ADJUST-BODY) * 2.5));'
                    echo 'transform: translateY(calc(10% * (' | append: quotes_shift_multiplier | append: ' * 0.833)));'
                  endcapture
                -%}

                <blockquote class="{{ font_size_class }}">
                  {%- if show_quotation_marks -%}
                    <span class="review__quote review__quote--open{% if section.settings.padding_top > 9 %} review__quote--open-negative{% endif %}">
                      <span class="review__quote-inner" style="{{ quotes_styles }}">&ldquo;</span>
                    </span>
                  {%- endif -%}

                  <p>{{ review | truncatewords: 200 }}</p>

                  {%- if show_quotation_marks -%}
                    <span class="review__quote review__quote--close{% if section.settings.padding_bottom > 9 %} review__quote--close-negative{% endif %}">
                      <span class="review__quote-inner" style="{{ quotes_styles }}">&rdquo;</span>
                    </span>
                  {%- endif -%}
                </blockquote>
              {%- endif -%}

              {%- if block_title != blank or subheading != blank or bio_image != blank -%}
                <div class="review__author">
                  {%- if bio_image != blank -%}
                    <div class="review__author__bio-image">
                      {%- liquid
                        assign widths = '34, 68, 136, 272, 544, 1088'
                        assign sizes = '34px'
                        assign width_retina = '68'

                        render 'image' image: bio_image, width: width_retina, sizes: sizes, widths: widths, cover: true
                      -%}
                    </div>
                  {%- endif -%}

                  {%- if block_title != blank or subheading != blank -%}
                    <div class="review__author__content">
                      {%- if block_title != blank -%}
                        <div class="review__author__name">{{ block_title }}</div>
                      {%- endif -%}

                      {%- if subheading != blank -%}
                        <span class="review__author__subheading subheading">{{ subheading }}</span>
                      {%- endif -%}
                    </div>
                  {%- endif -%}
                </div>
              {%- endif -%}
            </div>
          {%- if review_url != blank -%}
            </a>
          {%- else -%}
            </div>
          {%- endif -%}

        </div>
      {%- endfor -%}
    </div>
  {%- else -%}
    {%- render 'no-blocks' -%}
  {%- endif -%}
</div>

{% schema %}
{
  "name": "Testimonials",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "show_featured_image",
      "label": "Show featured image",
      "default": true
    },
    {
      "type": "range",
      "id": "image_aspect_ratio",
      "min": 0.5,
      "max": 1.5,
      "step": 0.1,
      "unit": ":1",
      "label": "Image height",
      "info": "Wide to tall",
      "default": 1.3
    },
    {
      "type": "checkbox",
      "id": "show_quotation_marks",
      "label": "Show quotation marks",
      "default": true
    },
    {
      "type": "select",
      "id": "text_align",
      "label": "Text alignment",
      "default": "text-left",
      "options": [
        {
          "value": "text-left",
          "label": "Left"
        },
        {
          "value": "text-center",
          "label": "Centered"
        }
      ]
    },
    {
      "type":  "range",
      "id":    "text_size",
      "label": "Text size",
      "min": 1,
      "max": 15,
      "step": 1,
      "default": 4
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Background"
    },
    {
      "type": "color",
      "id": "color",
      "label": "Text"
    },
    {
      "type": "color",
      "id": "card_bg_color",
      "label": "Card background"
    },
    {
      "type": "header",
      "content": "Section padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Padding top",
      "default": 50
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 1,
      "unit": "px",
      "label": "Padding bottom",
      "default": 50
    }
  ],
  "blocks": [
    {
      "type": "review",
      "name": "Testimonial",
      "settings": [
        {
          "type": "header",
          "content":"Testimonial"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Customer name",
          "default": "Example Customer"
        },
        {
          "type": "text",
          "id": "subheading",
          "label": "Subheading",
          "default": "Industry Expert"
        },
        {
          "type": "textarea",
          "id": "review_text",
          "label": "Testimonial",
          "default": "Use this text to showcase a review from one of your customers. A great review is honest and speaks to the concerns of your customers."
        },
        {
          "type": "image_picker",
          "id": "featured_image",
          "label": "Featured image"
        },
        {
          "type": "image_picker",
          "id": "bio_image",
          "label": "Bio image"
        },
        {
          "type": "header",
          "content": "Review link",
          "info": "Whole block turns into a link"
        },
        {
          "type": "url",
          "id": "review_url",
          "label": "Link"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Testimonials",
      "category": "Text",
      "blocks": [
        {
          "type": "review",
          "settings": {
            "title":"Jeremy Usborne"
          }
        },
        {
          "type": "review",
          "settings": {
            "title":"Willy Bridge"
          }
        },
        {
          "type": "review",
          "settings": {
            "title":"Kenneth Powell"
          }
        }
      ]
    }
  ],
  "disabled_on": {
    "groups": ["header", "footer"]
  }
}
{% endschema %}
